name: Deploy Next.js to Azure Web App

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      WEBAPP_NAME: wizlo-marketing-webapp
      RESOURCE_GROUP: wizlo-rg
      LOCATION: centralus

    steps:
      - name: Checkout pipeline repo
        uses: actions/checkout@v4

      - name: Checkout marketing website (private repo)
        uses: actions/checkout@v4
        with:
          repository: smarter-EMR/wizlo-marketing-website
          token: ${{ secrets.GH_PAT }}
          ref: main
          path: repo

      # Login to Azure
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Create RG if not exists
      - name: Create Resource Group
        run: |
          az group create \
            --name $RESOURCE_GROUP \
            --location $LOCATION

      # Create Web App if not exists
      - name: Create Web App if not exists
        run: |
          if ! az webapp show --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP &> /dev/null; then
            echo "Web App does not exist. Creating..."
            az appservice plan create \
              --name "${WEBAPP_NAME}-plan" \
              --resource-group $RESOURCE_GROUP \
              --sku B1 \
              --is-linux

            az webapp create \
              --resource-group $RESOURCE_GROUP \
              --plan "${WEBAPP_NAME}-plan" \
              --name $WEBAPP_NAME \
              --runtime "NODE|20-lts"
          else
            echo "Web App already exists. Skipping create."
          fi

      # Set Node version for the Web App
      - name: Configure Web App runtime
        run: |
          az webapp config set \
            --resource-group $RESOURCE_GROUP \
            --name $WEBAPP_NAME \
            --linux-fx-version "NODE|20-lts"

      # Build Next.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install dependencies
        run: |
          cd repo
          npm ci

      - name: Build Next.js
        run: |
          cd repo
          npm run build

      - name: Archive production build
        run: |
          cd repo
          zip -r ../app.zip .

      # Deploy to Azure Web App
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.WEBAPP_NAME }}
          package: app.zip

      - name: Print Web App URL
        run: |
          echo "Deployed: https://${WEBAPP_NAME}.azurewebsites.net"
